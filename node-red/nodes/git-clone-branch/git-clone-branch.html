<style>
    .nr-form {
        font-size: 12px;
        opacity: .7;
        margin-top: 4px;
        margin-left:105px;
        color:#d32f2f;
    }
</style>

<script type="text/html" data-help-name="git-clone-branch">
    <p>Define o branch do projeto a ser clonado.</p>
    <h3>Entradas</h3>
    <dl class="message-properties">
        <dt>Formulário manual</dt>
        <dd>O desenvolvedor necessita informar o nome do branch a ser clonado.</dd>
    </dl>

    <h3>Saídas</h3>
    <dl class="message-properties">
        <dt>get:clone <span class="property-type">object</span></dt>
        <dd>Retorna a configuração do git.</dd>
    </dl>
</script>

<script type="text/html" data-template-name="git-clone-branch">
    <div class="form-row">
        <label for="node-input-cloneBranch">Usuário</label>
        <input type="text" id="node-input-cloneBranch" placeholder="Usuário">
        <div id="node-input-cloneBranch-help" class="nr-form"></div>
    </div>

    <div class="form-row">
        <div class="connections-erros form-tips" style="display:none;"></div>
    </div>

</script>


<script type="text/javascript">
    (() => {
        class WiringRules {
            #allowed;
            #necessary;
            #connected;

            constructor(allowed = [], necessary = []) {
                this.#allowed = allowed;
                this.#necessary = necessary;
                this.#connected = [];
            }

            add(id) {
                this.#connected.push(id);
                return this.verify(id);
            }

            remove(id) {
                const i = this.#connected.indexOf(id);
                if (i !== -1) this.#connected.splice(i, 1);
            }

            verify(id) {
                return this.#allowed.includes(id);
            }

            missing() {
                return this.#necessary.filter(x => !new Set(this.#connected).has(x));
            }

            error() {
                const missing = wiring.missing()
                const $form = $("#dialog-form");
                const $err  = $form.find(".connections-erros");
                if(missing.length !== 0) {
                    $err.html(wiring.#error);
                    $err.show();
                    return;
                }
                $err.hide();
            }

            get #error() {
                const items = this.missing();
                if (!Array.isArray(items) || items.length === 0) return "";
                const esc = s => String(s).replace(/[&<>"']/g, m =>
                    ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
                const lis = items.map(i => `<li>${esc(i)}</li>`).join("");
                return `<p><strong>Lista de conexões faltando:</strong></p><ul>${lis}</ul>`;
            }
        }



        const node = this;
        const registerType = "git-clone-branch";
        const paletteLabel = "git-clone-branch";
        const category = "git";
        const icon = "font-awesome/fa-code-fork";
        const componentColor = "#aaaaaa";
        const inputs = 0
        const outputs = 1

        const connectionAllowed = ["git-pass"];
        const connectionNecessary = ["git-pass"];

        node.cloneBranchSelector = "#clone-branch";
        node.cloneBranchPartner  = /^(?!@$)(?!-)(?!\.)(?!.*\/\.)(?!.*\.\.)(?!.*\/\/)(?!.*@{)(?!.*(?:^|\/)[^/]*\.lock(?:\/|$))(?!.*\.$)[^ \x00-\x1F\x7F~^:?*\[\\]+(?:\/[^ \x00-\x1F\x7F~^:?*\[\\]+)*$/;
        node.cloneBranchHelp     = "O nome do branch deve seguir as regras oficiais";

        const wiring = new WiringRules(connectionAllowed,connectionNecessary);

        function validateField(selector,pattern,helpText) {
            selector = "#node-input-"+selector.slice(1);
            const f = function(selector,pattern,helpText){
                if(!$(selector).length) {
                    return;
                }

                const value = $(selector).val();
                const nameFilterPass = pattern.test(value);
                if (!nameFilterPass) {
                    $(selector+"-help").html(helpText);
                    $(selector+"-help").show();
                    return
                }
                $(selector+"-help").hide();

            }
            $(selector).keyup(function() {
                f(selector,pattern,helpText);
            });
            $(selector).blur(function() {
                f(selector,pattern,helpText);
            });
            f(selector,pattern,helpText);
        }

        RED.nodes.registerType(registerType,{
            category: category,
            color: componentColor,
            defaults: {
                cloneBranch: { value: "", required: true }
            },
            inputs: inputs,
            outputs: outputs,
            icon: icon,
            label: function() {
                return this.name ? paletteLabel+": "+this.name : paletteLabel;
            },
            oneditsave: function(){
                node.cloneBranch     = $(node.cloneBranchSelector).val();
            },
            oneditprepare: function() {
                validateField(node.cloneBranchSelector, node.cloneBranchPartner, node.cloneBranchHelp);
                $(node.cloneBranchSelector).val(node.cloneBranch);
                wiring.error("#git-clone-branch-error");
            }
        });

        RED.events.on('links:add', function(link) {
            const src = RED.nodes.node(link.source.id);
            const dst = RED.nodes.node(link.target.id);

            if( wiring.add(dst?.type) ){
                RED.notify("Conexão ok: '"+src?.type+"' → '"+dst?.type+"'", "success");
                return;
            }

            RED.notify("Conexão inválida: '"+src?.type+"' → '"+dst?.type+"'", "error");
        });

        RED.events.on('links:remove', function(link) {
            // const src = RED.nodes.node(link.source.id);
            const dst = RED.nodes.node(link.target.id);

            wiring.remove(dst?.type)
        });
    })();
</script>
