<script type="text/html" data-template-name="make-dir">
    <div class="form-row">
        <label for="node-input-name">Diretório</label>
        <input type="text" id="node-input-name" placeholder="Nome do diretório permanente">
    </div>

    <style>.sl-theme-dark{color-scheme:dark}</style>
</script>

<script type="text/html" data-help-name="make-dir">
    <p>Define onde clonar o repositório.</p>
    <p>Caso queira criar um diretório em <b>/git/_seu_diretorio_</b>, preencha o compo diretório.</p>
    <p>Caso contrário, deixe-o em branco para ser criado um diretório temporário, a ser apagado no final do processo.</p>
    <p><b>/git/_seu_diretorio_</b> fica na raiz do container e pode ser compartilhado com o computador hospedeiro.</p>
    <p><b>docker run --name recode \<br>-v _diretorio_local_:/git/_diretorio_servidor_ \<br>...</b></p>
</script>

<script type="text/javascript">
    (function(){
        // Carrega Shoelace e aguarda <sl-drawer> estar definido
        function ensureShoelaceReady() {
            if (!window.__slOnce) {
                const css = document.createElement('link');
                css.rel = 'stylesheet'; css.href = '/shoelace/themes/dark.css';
                document.head.appendChild(css);
                const mod = document.createElement('script');
                mod.type = 'module'; mod.src = '/shoelace/autoloader.js';
                document.head.appendChild(mod);
                window.__slOnce = customElements.whenDefined('sl-drawer');
            }
            return window.__slOnce;
        }

        RED.nodes.registerType("make-dir", {
            category: "git",
            color: "#0ae3a3",
            icon: "font-awesome/fa-code-fork",
            defaults: {
                name:   { value: "" },
                info:   { value: "" },
                server: { value: "http://localhost:8080" },
                repo:   { value: "" },
                branch: { value: "" },
                dest:   { value: "" }
            },
            inputs: 1,
            outputs: 1,
            label: function(){
                if(this.name == "") {
                    return "make-dir: tmp dir";
                }
                return "make-dir: "+this.name;
            },

            oneditprepare: function () {
                const node = this;

                $("#node-input-name").val(node.name);
                $("#node-input-info").val(node.info || "Git clone panel with live log (SSE)");
                $("#node-input-server").val(node.server || "http://localhost:8080");
                $("#node-input-repo").val(node.repo);
                $("#node-input-branch").val(node.branch);
                $("#node-input-dest").val(node.dest);

                const drawer   = document.getElementById("slgc-drawer");
                const btnOpen  = document.getElementById("slgc-open");
                const inRepo   = document.getElementById("slgc-repo");
                const inBranch = document.getElementById("slgc-branch");
                const inDest   = document.getElementById("slgc-dest");
                const btnRun   = document.getElementById("slgc-run");
                const btnClear = document.getElementById("slgc-clear");
                const logBox   = document.getElementById("slgc-log");
                const statusEl = document.getElementById("slgc-status");

                let es = null;
                const getServer = () => ($("#node-input-server").val() || "http://localhost:8080").replace(/\/+$/,"");

                function setStatus(t){ statusEl.textContent = t; }

                function appendLog(line){
                    logBox.textContent += line;
                    logBox.scrollTop = logBox.scrollHeight;
                }

                function startSSE() {
                    stopSSE();
                    const url = `${getServer()}/git/clone/stream/${node.id}`;
                    console.log("[clone] SSE ->", url);

                    try {
                        es = new EventSource(url);
                    } catch (e) {
                        console.error("[clone] EventSource error:", e);
                        setStatus("SSE error");
                        return;
                    }
                    setStatus("connecting…");

                    es.addEventListener("message", (ev) => {
                        if (!ev.data) return;
                        try {
                            const msg = JSON.parse(ev.data);
                            if (msg.type === "hello") { setStatus("connected"); appendLog(ev.data); return; }
                            if (msg.type === "log")   appendLog(`[${msg.stream}] ${msg.line}`);
                            if (msg.type === "done")  appendLog(`\n[DONE] exit code ${msg.code}, target: ${msg.target}\n`);
                        } catch (e) {
                            // dados que não são JSON (ignora)
                            appendLog(e.message);
                        }
                    });
                    es.addEventListener("ping", () => { /* heartbeat */ });
                    es.onerror = () => { setStatus("disconnected"); };
                }

                function stopSSE(){
                    if (es) { es.close(); es = null; }
                }

                async function startClone() {
                    $("#node-input-repo").val(inRepo.value);
                    $("#node-input-branch").val(inBranch.value);
                    $("#node-input-dest").val(inDest.value);

                    const payload = {
                        nodeId:  node.id,
                        repo:    inRepo.value,
                        branch:  inBranch.value,
                        destDir: inDest.value
                    };
                    const url = `${getServer()}/git/clone/start`;
                    console.log("[clone] POST ->", url, payload);

                    try {
                        const resp = await fetch(url, {
                            method: "POST",
                            headers: {"Content-Type":"application/json"},
                            body: JSON.stringify(payload)
                        });
                        const data = await resp.json().catch(() => ({}));
                        appendLog(`-> clone started pid=${data.pid} target=${data.target}\n`);
                    } catch (e) {
                        appendLog("[ERROR] start: "+e+"\n");
                    }
                }

                // Botão principal
                btnOpen.addEventListener("click", async () => {
                    inRepo.value   = $("#node-input-repo").val() || "";
                    inBranch.value = $("#node-input-branch").val() || "";
                    inDest.value   = $("#node-input-dest").val() || "";

                    logBox.textContent = "";
                    startSSE();

                    await ensureShoelaceReady();
                    if (typeof drawer.show === "function") drawer.show(); else drawer.setAttribute("open","");

                    startClone();
                });

                btnRun.addEventListener("click", startClone);
                btnClear.addEventListener("click", () => { logBox.textContent = ""; });
                drawer?.addEventListener("sl-after-hide", stopSSE);
            },

            oneditsave: function(){
                this.name   = $("#node-input-name").val();
                this.info   = $("#node-input-info").val();
                this.server = $("#node-input-server").val() || "http://localhost:8080";
                this.repo   = $("#node-input-repo").val();
                this.branch = $("#node-input-branch").val();
                this.dest   = $("#node-input-dest").val();
            }
        });
    })();
</script>
